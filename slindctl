#!/bin/sh

CONFIG_FILE=~/.slind-config
if [ ! -f $CONFIG_FILE ]; then
	echo "Config file $CONFIG_FILE not found, creating one for you."
	cp /etc/slind/slind-config $CONFIG_FILE
fi

. $CONFIG_FILE

CHROOTCMD="$ROOTCMD chroot $TARGET su - build -c"
HOSTARCH=`dpkg --print-architecture`
GNUARCH=`dpkg-architecture -a$ARCH -qDEB_HOST_GNU_TYPE 2>/dev/null` || true

# list of basic target packages
BASEPKGLIST="base-files base-passwd busybox sysvinit ifupdown netbase dpkg miniperl apt"
# list of host packages that we need to install before
# we can even run package builder
PKGLIST="dpkg dpkg-dev dpkg-cross northern-cross g++-4.1-$GNUARCH linux-kernel-headers-${ARCH}-cross i386-toolchain toolchain-package debootstrap adduser libglib2.0-dev fakechroot cross-shell debhelper"
MAINTAINER_PKGLIST="sudo adduser realpath lsb-release flex sqlite3 dpatch cdbs quilt git-core debhelper debootstrap fakeroot pkg-config autoconf2.13 automake1.7 zlib1g-dev libncurses5-dev libcurl3-dev libpopt-dev docbook-to-man texi2html texinfo curl"

# These all should be overrideable from configuration files
# See grasp documentation for the actual meaning of those.
[ -n "$GITBASE_URL" ]  || GITBASE_URL="http://git.slind.org/gitrepos/"
[ -n "$GITREPOS_DIR" ] || GITREPOS_DIR="/build/grasp-repos"
[ -n "$TARBALLS_DIR" ] || TARBALLS_DIR="/build/grasp-tarballs"
[ -n "$GRASP_REPO" ]   || GRASP_REPO="/build/grasp-out"

# hook functions
[ -n "$PRE_SLINDJOB_HOOK" ]  || PRE_SLINDJOB_HOOK=empty_hook
[ -n "$POST_SLINDJOB_HOOK" ] || POST_SLINDJOB_HOOK=empty_hook

empty_hook() {
	true
}

# hackaround for the case of non-existing locales
export LC_ALL=C

# some shells don't export UID variable
if [ -z "$UID" ]; then
       UID=`id -u`
fi

# 1. bootstrap building environment
dev_bootstrap() {
	echo "=== dev_bootstrap ==="
	$ROOTCMD debootstrap --variant=buildd $DEBSUITE $TARGET $MIRROR
	if [ "$?" != "0" ]; then
		echo "Failed to bootstrap $DEBSUITE from $MIRROR to $TARGET"
		exit 1
	fi
}

# 1.5. configure target
configure_target() {
	echo "=== configure_target ==="
	$ROOTCMD cp /etc/hosts $TARGET/etc/hosts	
}

# 2. copy tools inside
copy_tools() {
	echo "=== copy_tools ==="
	if [ "${TOOLSDIR#http*:}" = "$TOOLSDIR" ]; then
	        echo "Copying $TOOLSDIR to $TARGET/tools"
		$ROOTCMD mkdir -p $TARGET/tools
		( cd $TOOLSDIR; tar -c --exclude CVS * ) | \
			$ROOTCMD tar xf - -C $TARGET/tools
	        # for the chroot environment, the tools are now in /tools
	        TOOLSDIR="file:///tools"
	else
	        echo "Tools are on HTTP server. No local copying needed."
	fi
	if [ "${SLINDSRC#http*:}" = "$SLINDSRC" ]; then
	        echo "Copying $SLINDSRC to $TARGET/slind"
		$ROOTCMD mkdir -p $TARGET/slind
		( cd $SLINDSRC; tar -c --exclude CVS * ) | \
			$ROOTCMD tar xf - -C $TARGET/slind
	        # for the chroot environment...
	        SLINDSRC="file:///slind"
	else
		$ROOTCMD mkdir -p $TARGET/slind
		$ROOTCMD wget $SLINDSRC/$SUITE -O $TARGET/slind/$SUITE

	        echo "Slind repository is on HTTP server. No local copying needed."
	fi
	
}

# 3. configure apt
configure_apt() {
	local mode="$1"

	echo "=== configure_apt ==="
	echo "deb $MIRROR $DEBSUITE main" > sources.list

	if [ "$mode" = "maintainer" ]; then
		echo "deb $HSTOOLS_MIRROR $SUITE host-tools" >> sources.list
		echo "deb-src $HSTOOLS_MIRROR $SUITE core gui host-tools" >> sources.list
	else
		echo "deb $TOOLSDIR ./" >> sources.list
		echo "deb-src $SLINDSRC $SUITE main" >> sources.list
	fi

	$ROOTCMD mv sources.list $TARGET/etc/apt/sources.list
	$ROOTCMD chroot $TARGET apt-get update
}

# 4. install necessary packages
dev_install() {
	echo "=== dev_install ==="
	$ROOTCMD chroot $TARGET apt-get install --yes --force-yes $@
	$ROOTCMD chroot $TARGET apt-get clean
	#$ROOTCMD cp -a $SLINDSRC $TARGET/slind
}

# 4.5. create a user for building
add_user() {
	echo "=== add_user ==="
	if ! grep -q build $TARGET/etc/passwd; then
		$ROOTCMD chroot $TARGET /usr/sbin/adduser --home /build --uid $UID --disabled-password --disabled-login --gecos 'Build user' build
		# 4.6. configure sudo
		$ROOTCMD chroot $TARGET su - -c "echo 'build ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers"
	fi
}

# 4.6. configure grasp and friends
configure_tools() {
	GRASP_CONFIG="$TARGET/build/.grasp"
	: > $GRASP_CONFIG
	echo "gitbase_url $GITBASE_URL"   >> $GRASP_CONFIG
	echo "gitrepos_dir $GITREPOS_DIR" >> $GRASP_CONFIG
	echo "tarballs_dir $TARBALLS_DIR" >> $GRASP_CONFIG
	echo "reget_grasp yes"            >> $GRASP_CONFIG
	echo "output_dir $GRASP_REPO"     >> $GRASP_CONFIG
	echo "repo_format 2"              >> $GRASP_CONFIG
}

# 5. build everything
build_for_host() {
	echo "=== build_for_host ==="
	for pkg in $BASEPKGLIST; do
		$CHROOTCMD "nc build $pkg --arch $HOSTARCH --path /slind"
	done
}

build_for_target() {
	echo "=== build_for_target ==="
	$CHROOTCMD "nc world --arch $ARCH --path /slind"
}

update_lists() {
	$CHROOTCMD "nc update --arch $HOSTARCH --path /slind"
	$CHROOTCMD "nc update --arch $ARCH --path /slind"
}

# 6. bootstrap i386 rootfs
bootstrap_host() {
	echo "=== bootstrap_host ==="
	[ -f $TARGET/slind/$SUITE ] || $ROOTCMD cp ./$SUITE $TARGET/slind
	$ROOTCMD mkdir -p $TARGET/rootfs-$HOSTARCH
	$ROOTCMD chroot $TARGET debootstrap $SUITE /rootfs-$HOSTARCH $SLINDSRC /slind/$SUITE
	$ROOTCMD chmod u+s $TARGET/rootfs-$HOSTARCH/sbin/ldconfig
}

# 7. bootstrap $ARCH rootfs
bootstrap_target() {
	echo "=== bootstrap_target ==="
	$ROOTCMD mkdir -p $TARGET/rootfs-$ARCH
	$ROOTCMD sed -ie "s/^ARCH=.*$/ARCH=$ARCH/" $TARGET/etc/cross-shell.conf
	$ROOTCMD sed -ie "s,^REPO=.*$,REPO=$SLINDSRC," $TARGET/etc/cross-shell.conf
	$ROOTCMD chown -R $UID:$UID $TARGET/rootfs-$ARCH
	$CHROOTCMD "cross-shell bs"
	$CHROOTCMD "cross-shell apt $TARGET_APT"
	$CHROOTCMD "cross-shell pack"
}

case "$1" in
	all)
		dev_bootstrap
		configure_target
		copy_tools
		configure_apt
		dev_install $PKGLIST
		add_user
		build_for_host
		build_for_target
		update_lists
		bootstrap_host
		bootstrap_target
		;;
	*bootstrap*)
		update_lists
		bootstrap_host
		bootstrap_target
		;;
	*maintainer-setup*)
		if [ -z "$HSTOOLS_MIRROR" ]; then
			echo "ERROR: host-tools repository (HSTOOLS_MIRROR variable) is not set."
			exit 1
		fi
		dev_bootstrap
		configure_target
		configure_apt "maintainer"
		dev_install $MAINTAINER_PKGLIST
		add_user
		configure_tools
		;;
	*setup*)
		dev_bootstrap
		configure_target
		copy_tools
		configure_apt
		dev_install $PKGLIST
		add_user
		configure_tools
		;;
	*maintainer-build*)
		$PRE_SLINDJOB_HOOK
		set -e
		sh /usr/lib/slind-core/slind-host-tools-bootstrap --build
		$CHROOTCMD "$CHROOTENV slindjob"
		set +e
		$POST_SLINDJOB_HOOK
		;;
	*build*)
		build_for_host
		build_for_target
		update_lists
		;;
	*)
		echo "Usage: `basename $0` {all|bootstrap|maintainer-setup|setup|build}"
		exit 1
		;;
esac
